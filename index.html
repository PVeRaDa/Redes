<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Control LED (MQTT)</title>
  <style>
    body { font-family: sans-serif; max-width: 520px; margin: auto; padding: 16px; text-align: center; }
    button { padding: 12px 16px; margin: 8px; font-size: 16px; border-radius: 8px; cursor: pointer; }
    #status { margin-bottom: 12px; font-weight: bold; }
    #log { text-align: left; border: 1px solid #ddd; padding: 10px; height: 220px; overflow: auto; border-radius: 8px; background:#fafafa; }
    .ts { color:#666; font-size:12px; }
    .ok { color:green; }
    .err { color:red; }
    .msg { color:#333; }
  </style>
</head>
<body>
  <h2>ESP32 LED por MQTT</h2>
  <div id="status">Conectando…</div>

  <p>
    <button id="btnOn">Encender</button>
    <button id="btnOff">Apagar</button>
    <button id="btnToggle">Toggle</button>
  </p>

  <p>Estado del LED: <span id="ledState">?</span></p>

  <h3>Logs</h3>
  <div id="log"></div>

  <!-- Cargar Paho desde un único CDN (Cloudflare) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/mqttws31.min.js"></script>

  <script>
    // === Configuración MQTT ===
    const isHttps = location.protocol === "https:";  // Detecta HTTPS
    const HOST = "broker.hivemq.com";
    const PATH = "/mqtt";
    const PORT = 8080;
    const USE_SSL = false;
    

    // Topics (coinciden con tu ESP32)
    const TOPIC_CMD   = "pedro/esp32/led/cmd";          // web -> esp32
    const TOPIC_STATE = "pedro/esp32/led/state";        // esp32 -> web
    const TOPIC_AVAIL = "pedro/esp32/led/availability"; // esp32 -> web (online/offline)

    // Helpers de UI
    const $ = (id) => document.getElementById(id);
    const log = (html, cls="msg") => {
      const ts = new Date().toLocaleTimeString();
      $("log").insertAdjacentHTML("afterbegin", `<div class="${cls}"><span class="ts">[${ts}]</span> ${html}</div>`);
    };

    // Verifica que Paho esté cargado
    if (typeof Paho === "undefined") {
      $("status").textContent = "Error: Paho no cargó";
      $("status").className = "err";
      log("La librería Paho no se cargó. Revisa el CDN o bloqueadores.", "err");
      throw new Error("Paho no está definido");
    }

    // Crear cliente
    const clientId = "webclient-" + Math.random().toString(16).slice(2);
    const client = new Paho.MQTT.Client(HOST, Number(PORT), PATH, clientId);

    // Eventos del cliente
    client.onConnectionLost = (resp) => {
      $("status").textContent = "Desconectado: " + (resp.errorMessage || "");
      $("status").className = "err";
      log("Conexión perdida: " + (resp.errorMessage || "(sin detalle)"), "err");
      setTimeout(connect, 2000);
    };

    client.onMessageArrived = (message) => {
      const topic = message.destinationName;
      const payload = (message.payloadString || "").toLowerCase();
      log(`RX <b>${topic}</b> = <code>${payload}</code>`);
      if (topic === TOPIC_STATE) {
        $("ledState").textContent = payload === "on" ? "ENCENDIDO" : "APAGADO";
        $("ledState").style.color = payload === "on" ? "green" : "gray";
      }
      if (topic === TOPIC_AVAIL) {
        log(`Disponibilidad: <b>${payload}</b>`);
      }
    };

    // Conectarse
    function connect() {
      $("status").textContent = "Conectando…";
      $("status").className = "";
      log(`Conectando a ${HOST}:${PORT} ${USE_SSL ? "(wss)" : "(ws)"}`);
      client.connect({
        timeout: 5,
        useSSL: USE_SSL,
        mqttVersion: 4,       // MQTT 3.1.1
        keepAliveInterval: 30,
        onSuccess: () => {
          $("status").textContent = "Conectado a HiveMQ";
          $("status").className = "ok";
          log("Conectado ✅", "ok");
          client.subscribe(TOPIC_STATE, { qos: 0 });
          client.subscribe(TOPIC_AVAIL, { qos: 0 });
          log(`Suscrito a <b>${TOPIC_STATE}</b> y <b>${TOPIC_AVAIL}</b>`);
        },
        onFailure: (err) => {
          $("status").textContent = "Error: " + err.errorMessage;
          $("status").className = "err";
          log("Error al conectar: " + err.errorMessage, "err");
          setTimeout(connect, 3000);
        },
      });
    }

    // Publicar comandos
    function publishCmd(cmd) {
      const msg = new Paho.MQTT.Message(cmd);
      msg.destinationName = TOPIC_CMD;
      client.send(msg);
      log(`TX <b>${TOPIC_CMD}</b> = <code>${cmd}</code>`);
    }

    $("btnOn").onclick = () => publishCmd("on");
    $("btnOff").onclick = () => publishCmd("off");
    $("btnToggle").onclick = () => publishCmd("toggle");

    connect();
  </script>
</body>
</html>
